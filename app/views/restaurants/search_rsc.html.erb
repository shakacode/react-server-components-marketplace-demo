<%= stream_react_component_with_async_props("SearchPageRSC", props: { restaurants: @restaurants }, prerender: true) do |emit|
  @restaurants.each do |r|
    emit.call("restaurant_#{r.id}_widgets", {
      status: r.current_status,
      wait_time: r.current_wait_time,
      specials: r.active_promotions.map { |p|
        { id: p.id, title: p.title, description: p.description,
          discount_type: p.discount_type, discount_value: p.discount_value.to_f,
          code: p.code, ends_at: p.ends_at.iso8601 }
      },
      trending: r.trending_items.map { |item|
        { id: item.id, name: item.name, category: item.category,
          price: item.price.to_f, description: item.description }
      }
    })
  end
end %>
